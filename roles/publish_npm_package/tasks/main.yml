- name: verify that version_increment_level is appropriate
  assert:
    that:
      - "version_increment_level in ['major', 'minor', 'patch']"

- name: empty the temp_dir
  file:
    path: "{{ temp_dir }}"
    state: absent

- name: create the temp_dir
  file:
    path: "{{ temp_dir }}"
    state: directory

- name: get source code
  git:
    repo: "{{ repo_url }}"
    dest: "{{ temp_dir }}"
    force: yes
    version: "{{ version }}"

- name: switch to .nvmrc version
  shell: nvm use
  args:
    chdir: "{{ temp_dir }}"
    removes: .nvmrc

- name: install npm dependencies for build
  npm:
    path: "{{ temp_dir }}"
    production: no

- name: run npm test
  command: npm test
  args:
    chdir: "{{ temp_dir }}"

- name: increment package version
  command: npm version {{ version_increment_level }}
  args:
    chdir: "{{ temp_dir }}"

- name: commit package version increment
  command: git push origin {{ version }}
  args:
    chdir: "{{ temp_dir }}"

- name: publish npm package
  command: npm publish
  args:
    chdir: "{{ temp_dir }}"

- name: empty the temp_dir
  file:
    path: "{{ temp_dir }}"
    state: absent

- name: notify knightwatcher
  command: utils/knightwatcher.js
    --message-type npm-publish
    --repo-name {{ repo_name }}
    --link https://www.npmjs.com/package/{{ repo_name }}
    --username {{ deploy_user }}
  args:
    chdir: "{{ inventory_dir }}"
